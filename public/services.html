<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services - KrishiLink</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <a href="/" class="logo">ðŸŒ¾ KrishiLink</a>
            <nav>
                <ul class="nav-menu">
                    <li><a href="/">Home</a></li>
                    <li><a href="/community">Community</a></li>
                    <li><a href="/pricing">Market Prices</a></li>
                    <li><a href="/services">Services</a></li>
                    <li><a href="/login">Login</a></li>
                    <li><a href="/register">Register</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="content-wrapper">
                <h1 class="text-center mb-4">Agricultural Services</h1>
                <p class="text-center mb-4">Find tools, labor, storage, and other agricultural services in your area</p>

                <!-- Add Listing Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Post a Service/Listing</h3>
                    </div>
                    <div class="card-body">
                        <form id="listingForm">
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="listingTitle">Title</label>
                                    <input type="text" id="listingTitle" name="title" class="form-control" 
                                           placeholder="e.g., Tractor for Rent" required>
                                </div>
                                <div class="form-group">
                                    <label for="listingCategory">Category</label>
                                    <select id="listingCategory" name="category" class="form-control" required>
                                        <option value="">Select category</option>
                                        <option value="crop">Crops for Sale</option>
                                        <option value="tool">Tools & Equipment</option>
                                        <option value="labor">Labor Services</option>
                                        <option value="storage">Storage Facilities</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="listingSubcategory">Subcategory</label>
                                    <input type="text" id="listingSubcategory" name="subcategory" class="form-control" 
                                           placeholder="e.g., Tractor, Harvester, Farm Labor" required>
                                </div>
                                <div class="form-group">
                                    <label for="listingPrice">Price</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="number" id="listingPrice" name="price.amount" class="form-control" 
                                               placeholder="Amount" required style="flex: 2;">
                                        <input type="text" id="listingPriceUnit" name="price.unit" class="form-control" 
                                               placeholder="per day/hour/kg" required style="flex: 1;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="listingDescription">Description</label>
                                <textarea id="listingDescription" name="description" class="form-control" rows="4" 
                                          placeholder="Detailed description of your service/product..." required></textarea>
                            </div>

                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="listingState">State</label>
                                    <input type="text" id="listingState" name="location.state" class="form-control" 
                                           placeholder="e.g., Maharashtra" required>
                                </div>
                                <div class="form-group">
                                    <label for="listingDistrict">District</label>
                                    <input type="text" id="listingDistrict" name="location.district" class="form-control" 
                                           placeholder="e.g., Pune" required>
                                </div>
                            </div>

                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="listingPhone">Contact Phone</label>
                                    <input type="tel" id="listingPhone" name="contact.phone" class="form-control" 
                                           placeholder="10-digit mobile number" required>
                                </div>
                                <div class="form-group">
                                    <label for="listingEmail">Contact Email (Optional)</label>
                                    <input type="email" id="listingEmail" name="contact.email" class="form-control" 
                                           placeholder="your@email.com">
                                </div>
                            </div>

                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label for="listingAvailableFrom">Available From</label>
                                    <input type="date" id="listingAvailableFrom" name="availability.from" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="listingAvailableTo">Available Until (Optional)</label>
                                    <input type="date" id="listingAvailableTo" name="availability.to" class="form-control">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="listingNegotiable" name="price.negotiable" checked>
                                    Price is negotiable
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary">Post Listing</button>
                        </form>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Filter Services</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-4">
                            <div>
                                <label for="categoryFilter">Category</label>
                                <select id="categoryFilter" class="form-control">
                                    <option value="">All Categories</option>
                                    <option value="crop">Crops</option>
                                    <option value="tool">Tools & Equipment</option>
                                    <option value="labor">Labor Services</option>
                                    <option value="storage">Storage</option>
                                </select>
                            </div>
                            <div>
                                <label for="locationFilter">Location</label>
                                <input type="text" id="locationFilter" class="form-control" placeholder="State or District">
                            </div>
                            <div>
                                <label for="priceRangeFilter">Max Price</label>
                                <input type="number" id="priceRangeFilter" class="form-control" placeholder="Maximum price">
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button id="applyServiceFilters" class="btn btn-primary" style="width: 100%;">Apply Filters</button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <input type="text" id="searchServices" class="form-control" placeholder="Search services...">
                        </div>
                    </div>
                </div>

                <!-- Services Grid -->
                <div id="servicesContainer" class="grid grid-2">
                    <div class="text-center p-4">
                        <p>Loading services...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="servicesPagination" class="text-center mt-4">
                    <!-- Pagination will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 KrishiLink. Empowering Agriculture Through Technology.</p>
        </div>
    </footer>

    <script src="/js/main.js"></script>
    <script>
        let currentServicesPage = 1;
        let serviceFilters = {};

        // Listing form validation
        function validateListingForm() {
            let isValid = true;
            
            const title = document.getElementById('listingTitle');
            const category = document.getElementById('listingCategory');
            const subcategory = document.getElementById('listingSubcategory');
            const price = document.getElementById('listingPrice');
            const priceUnit = document.getElementById('listingPriceUnit');
            const description = document.getElementById('listingDescription');
            const state = document.getElementById('listingState');
            const district = document.getElementById('listingDistrict');
            const phone = document.getElementById('listingPhone');
            const availableFrom = document.getElementById('listingAvailableFrom');
            
            // Clear previous errors
            ['listingTitle', 'listingCategory', 'listingSubcategory', 'listingPrice', 'listingPriceUnit', 
             'listingDescription', 'listingState', 'listingDistrict', 'listingPhone', 'listingAvailableFrom'].forEach(clearError);
            
            // Validation checks
            if (!title.value.trim() || title.value.length < 5) {
                showError('listingTitle', 'Title must be at least 5 characters long');
                isValid = false;
            }
            
            if (!category.value) {
                showError('listingCategory', 'Please select a category');
                isValid = false;
            }
            
            if (!subcategory.value.trim()) {
                showError('listingSubcategory', 'Subcategory is required');
                isValid = false;
            }
            
            if (!price.value || parseFloat(price.value) <= 0) {
                showError('listingPrice', 'Please enter a valid price');
                isValid = false;
            }
            
            if (!priceUnit.value.trim()) {
                showError('listingPriceUnit', 'Price unit is required');
                isValid = false;
            }
            
            if (!description.value.trim() || description.value.length < 20) {
                showError('listingDescription', 'Description must be at least 20 characters long');
                isValid = false;
            }
            
            if (!state.value.trim()) {
                showError('listingState', 'State is required');
                isValid = false;
            }
            
            if (!district.value.trim()) {
                showError('listingDistrict', 'District is required');
                isValid = false;
            }
            
            if (!phone.value.trim() || !validatePhone(phone.value)) {
                showError('listingPhone', 'Please enter a valid 10-digit phone number');
                isValid = false;
            }
            
            if (!availableFrom.value) {
                showError('listingAvailableFrom', 'Available from date is required');
                isValid = false;
            }
            
            return isValid;
        }

        async function loadServicesWithFilters() {
            const servicesContainer = document.getElementById('servicesContainer');
            const paginationContainer = document.getElementById('servicesPagination');
            
            try {
                servicesContainer.innerHTML = '<div class="text-center p-4"><p>Loading services...</p></div>';
                
                const params = new URLSearchParams({
                    page: currentServicesPage,
                    limit: 12,
                    ...serviceFilters
                });
                
                const data = await apiRequest(`/listings?${params}`);
                
                if (data.listings && data.listings.length > 0) {
                    servicesContainer.innerHTML = data.listings.map(listing => `
                        <div class="card">
                            <div class="card-header">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h5 style="margin: 0;">${listing.title}</h5>
                                    <span class="badge" style="background: #4a7c59; color: white; text-transform: capitalize;">${listing.category}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${listing.description.substring(0, 120)}${listing.description.length > 120 ? '...' : ''}</p>
                                
                                <div class="mb-3">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <strong>Price:</strong>
                                        <span style="color: #ff6b35; font-weight: bold; font-size: 1.1rem;">
                                            â‚¹${listing.price.amount} ${listing.price.unit}
                                        </span>
                                    </div>
                                    ${listing.price.negotiable ? '<small class="text-muted">Price is negotiable</small>' : ''}
                                </div>
                                
                                <div class="mb-3">
                                    <div><strong>Location:</strong> ${listing.location.district}, ${listing.location.state}</div>
                                    <div><strong>Subcategory:</strong> ${listing.subcategory}</div>
                                    <div><strong>Available from:</strong> ${new Date(listing.availability.from).toLocaleDateString()}</div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Contact:</strong><br>
                                    <div>ðŸ“ž ${listing.contact.phone}</div>
                                    ${listing.contact.email ? `<div>ðŸ“§ ${listing.contact.email}</div>` : ''}
                                </div>
                                
                                <small class="text-muted">
                                    Posted by ${listing.seller.profile.fullName} â€¢ 
                                    ${new Date(listing.createdAt).toLocaleDateString()}
                                </small>
                            </div>
                        </div>
                    `).join('');
                    
                    // Generate pagination
                    if (data.pagination.pages > 1) {
                        let paginationHTML = '<div style="display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">';
                        
                        if (currentServicesPage > 1) {
                            paginationHTML += `<button class="btn btn-outline" onclick="changeServicesPage(${currentServicesPage - 1})">Previous</button>`;
                        }
                        
                        for (let i = Math.max(1, currentServicesPage - 2); i <= Math.min(data.pagination.pages, currentServicesPage + 2); i++) {
                            const isActive = i === currentServicesPage ? 'btn-primary' : 'btn-outline';
                            paginationHTML += `<button class="btn ${isActive}" onclick="changeServicesPage(${i})">${i}</button>`;
                        }
                        
                        if (currentServicesPage < data.pagination.pages) {
                            paginationHTML += `<button class="btn btn-outline" onclick="changeServicesPage(${currentServicesPage + 1})">Next</button>`;
                        }
                        
                        paginationHTML += '</div>';
                        paginationContainer.innerHTML = paginationHTML;
                    } else {
                        paginationContainer.innerHTML = '';
                    }
                } else {
                    servicesContainer.innerHTML = '<div class="text-center p-4"><p>No services available for the selected criteria</p></div>';
                    paginationContainer.innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading services:', error);
                servicesContainer.innerHTML = '<div class="text-center p-4"><p class="text-danger">Error loading services</p></div>';
            }
        }

        function changeServicesPage(page) {
            currentServicesPage = page;
            loadServicesWithFilters();
        }

        // Apply filters
        document.getElementById('applyServiceFilters').addEventListener('click', () => {
            const category = document.getElementById('categoryFilter').value;
            const location = document.getElementById('locationFilter').value;
            const maxPrice = document.getElementById('priceRangeFilter').value;
            const search = document.getElementById('searchServices').value;
            
            serviceFilters = {};
            if (category) serviceFilters.category = category;
            if (location) {
                serviceFilters.state = location;
                serviceFilters.district = location;
            }
            if (maxPrice) serviceFilters.maxPrice = maxPrice;
            if (search) serviceFilters.search = search;
            
            currentServicesPage = 1;
            loadServicesWithFilters();
        });

        // Initialize listing form handler
        handleFormSubmit('listingForm', validateListingForm, '/listings', (result) => {
            showSuccess('Listing posted successfully!');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        });

        // Override the default loadListings function
        window.loadListings = loadServicesWithFilters;

        // Set default available from date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('listingAvailableFrom').value = today;
        });
    </script>
</body>
</html>
